name: Modernization Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'shared/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'shared/**'
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  modernization-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./shared

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: shared/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript check
      run: npm run type-check

    - name: Check for deprecations
      run: npm run check:deprecations

    - name: Check for outdated dependencies
      run: npm run deps:check || true  # Don't fail on outdated deps

    - name: Security audit
      run: npm run deps:audit

    - name: Comment on PR with modernization suggestions
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // This would be enhanced to actually run the deprecation checker
          // and post results as PR comments
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '🔍 **Modernization Check Results**\n\nAutomated modernization check completed. Please review any deprecation warnings in the build logs.'
          });

  dependency-update-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    defaults:
      run:
        working-directory: ./shared

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: shared/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check for updates
      id: check_updates
      run: |
        OUTDATED=$(npm run deps:check --json 2>/dev/null || echo '{}')
        echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
        
    - name: Create modernization report
      run: |
        echo "# Weekly Modernization Report" > modernization-report.md
        echo "" >> modernization-report.md
        echo "## Deprecation Check" >> modernization-report.md
        npm run check:deprecations >> modernization-report.md || true
        echo "" >> modernization-report.md
        echo "## Dependency Status" >> modernization-report.md
        npm run deps:check >> modernization-report.md || true

    - name: Create Issue for Modernization
      if: steps.check_updates.outputs.outdated != '{}'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('./shared/modernization-report.md', 'utf8');
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `📦 Weekly Modernization Report - ${new Date().toISOString().split('T')[0]}`,
            body: report,
            labels: ['dependencies', 'modernization', 'weekly-report']
          });